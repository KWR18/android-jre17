name: Build Android JRE 17 (ARM64)
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git curl unzip zip autoconf make build-essential \
          libc6-dev libc6-dev-i386 libx11-dev libxext-dev libxrender-dev \
          libxt-dev libxtst-dev libasound2-dev libfreetype6-dev \
          systemtap-sdt-dev python3 openjdk-17-jdk-headless

    - name: Clone OpenJDK 17 source
      run: |
        git clone https://github.com/openjdk/jdk17u --depth 1 jdk17
        ls -l jdk17

    - name: Configure for Android ARM64
      run: |
        cd jdk17
        bash configure \
          --openjdk-target=aarch64-linux-android31 \
          --disable-warnings-as-errors \
          --with-toolchain-type=gcc \
          --with-jvm-variants=server \
          --with-debug-level=release

    - name: Build JRE 17
      run: |
        cd jdk17
        make images

    - name: Repack for Amethyst
      run: |
        mkdir out
        cd jdk17/build/*/images/jre
        tar -cJf ../../../../out/jre17-android-aarch64.tar.xz *

    - name: Upload runtime
      uses: actions/upload-artifact@v4
      with:
        name: jre17-android-aarch64
        path: out/jre17-android-aarch64.tar.xz
