name: Build Android JRE 17 (ARM64)
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt -y install autoconf unzip zip python3 systemtap-sdt-dev \
            libxtst-dev libasound2-dev libelf-dev libfontconfig1-dev \
            libx11-dev libxext-dev libxrandr-dev libxrender-dev libxt-dev

      - name: Clone Android OpenJDK build scripts (Pojav team fork)
        run: |
          git clone --depth 1 https://github.com/PojavLauncherTeam/android-openjdk-builds jdk-android
          cd jdk-android
          # Build JRE 17 for aarch64 (Android)
          TARGET_VERSION=17 ./1_ci_build_arch_aarch64.sh

      - name: Repack to Amethyst format
        run: |
          mkdir -p out
          # Find the JRE 17 android aarch64 tarball produced by the script
          JRE_TAR=$(ls -1 jdk-android/jre17-android*aarch64*.tar.xz | head -n1)
          # Repack so the archive root is bin/lib/release...
          mkdir repack && cd repack
          tar -xJf "../$JRE_TAR"
          # If top folder exists, enter it; then repack contents
          ROOT=$(ls -1)
          cd "$ROOT"
          tar -cJf "../../out/jre17-android-aarch64.tar.xz" *
          cd ../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: jre17-android-aarch64
          path: out/jre17-android-aarch64.tar.xz
